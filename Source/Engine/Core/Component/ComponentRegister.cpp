/*
  * Generated by cppsrc.sh
  * On 2015-08-20 17:27:44,24
  * by Paweu
*/
/*--END OF HEADER BLOCK--*/
#include <pch.h>
#include <nfMoonGlare.h>
#include "ComponentRegister.h"

namespace MoonGlare {
namespace Core {
namespace Component {

ComponentRegister::MapType *ComponentRegister::s_ComponentMap = nullptr;

void ComponentRegister::Dump(std::ostream &out) {
	out << "Component Register:\n";
	if (!s_ComponentMap) {
		out << "\tEmpty\n";
		return;
	}

	for (auto &it : *s_ComponentMap) {
		char buffer[128];
		sprintf_s(buffer, "\t%20s %4u\n", it.first.c_str(), (unsigned)it.second->m_CID);
		out << buffer;
	}
}

bool ComponentRegister::ExtractCIDFromXML(pugi::xml_node node, ComponentID & out) {
	auto idxml = node.attribute("Id");
	if (idxml) {
		out = idxml.as_uint(0);
		return out != (ComponentID)ComponentIDs::Invalid;
	} else {
		auto namexml = node.attribute("Name");
		if (!namexml) {
			AddLogf(Error, "Component definition without id or name!");
			return false;
		}
		if (GetComponentID(namexml.as_string(""), out)) {
			return out != (ComponentID)ComponentIDs::Invalid;
		} else {
			AddLogf(Error, "Unknown component name: %s", namexml.as_string(""));
			return false;
		}
	}
	return false;
}

int ComponentRegister::RegisterComponentApi(ApiInitializer & api) {
	int count = 0;
	{
		auto nComponent = api.beginNamespace("Component");
		for (auto &it : *s_ComponentMap) {
			auto &ci = *it.second;
			if (!ci.m_Flags.m_RegisterID)
				continue;
			nComponent.addProperty(ci.m_Name, ci.m_GetCID, (void(*)(int))nullptr);
		}
		nComponent.endNamespace();
		count = 1;
	}
	for (auto &it : *s_ComponentMap) {
		auto &ci = *it.second;
		if (!ci.m_ApiRegFunc)
			continue;
		ci.m_ApiRegFunc(api.beginNamespace("api").beginNamespace("Component"));
		++count;
	}
	return count;
}

} //namespace Component 
} //namespace Core 
} //namespace MoonGlare 
