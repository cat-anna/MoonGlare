/*
  * Generated by cppsrc.sh
  * On 2016-09-18 19:00:53,20
  * by Paweu
*/
/*--END OF HEADER BLOCK--*/

#pragma once
#ifndef ImageComponent_H
#define ImageComponent_H

#include "nfGUIComponent.h"
#include <Core/Component/AbstractComponent.h>
#include "../Animation.h"

namespace MoonGlare {
namespace GUI {
namespace Component {

using namespace Core::Component;

union ImageComponentEntryFlagsMap {
	struct MapBits_t {
		bool m_Valid : 1;
		bool m_Visible : 1;
	};
	MapBits_t m_Map;
	uint8_t m_UintValue;

	void SetAll() { m_UintValue = 0; m_UintValue = ~m_UintValue; }
	void ClearAll() { m_UintValue = 0; }

	static_assert(sizeof(MapBits_t) <= sizeof(decltype(m_UintValue)), "Invalid Function map elements size!");
};

struct ImageComponentEntry {
	Handle m_SelfHandle;
	Entity m_OwnerEntity;
	char padding[3];
	ImageComponentEntryFlagsMap m_Flags;

	float m_Speed;
	float m_Position;
	unsigned m_FrameCount;
	SharedAnimation m_Animation;

	void Reset() {
		m_Animation.reset();
	}

	void Update(float TimeDelta) {
		if (m_Speed > 0) {
			m_Position += m_Speed * TimeDelta;
			if ((unsigned)m_Position >= m_FrameCount) {
				int mult = static_cast<int>(m_Position / m_FrameCount);
				m_Position -= static_cast<float>(mult) * m_FrameCount;
			}
			//else
			//if (instance.Position < m_StartFrame) {
			//auto delta = m_EndFrame - m_StartFrame;
			//int mult = static_cast<int>(instance.Position / delta);
			//}
		}
	}
};
//static_assert((sizeof(RectTransformComponentEntry) % 16) == 0, "RectTransformComponentEntry has invalid size");
//static_assert(std::is_pod<RectTransformComponentEntry>::value, "RectTransformComponentEntry must be pod!");

class ImageComponent 
	: public TemplateStandardComponent<ImageComponentEntry, ComponentIDs::Image> {
public:
 	ImageComponent(ComponentManager *Owner);
 	virtual ~ImageComponent();
	virtual bool Initialize() override;
	virtual bool Finalize() override;
	virtual void Step(const Core::MoveConfig &conf) override;
	virtual bool Load(xml_node node, Entity Owner, Handle &hout) override;

	static void RegisterScriptApi(ApiInitializer &root);
protected:
	RectTransformComponent *m_RectTransform;
};

} //namespace Component 
} //namespace GUI 
} //namespace MoonGlare 

#endif
