/*
  * Generated by cppsrc.sh
  * On 2017-02-13 22:45:35,93
  * by Kalessin
*/
/*--END OF HEADER BLOCK--*/

#pragma once

#include <Assets/AssetLoaderInterface.h>

#include "../nfRenderer.h"
#include "../Configuration.Renderer.h"
#include "../Commands/CommandQueue.h"

namespace MoonGlare::Renderer::Resources {

class 
    //alignas(16) 
    TextureResource {
	using ThisClass = TextureResource;
	using Conf = Configuration::Texture;
	using ConfRes = Configuration::Resources;

public:
	void Initialize(ResourceManager* Owner, Asset::TextureLoader *TexLoader);
	void Finalize();


	bool Allocate(TextureResourceHandle &out);
	void Release(TextureResourceHandle h);

    bool LoadTexture(TextureResourceHandle &hout, const std::string &uri,
        Configuration::TextureLoad config = Configuration::TextureLoad::Default(),
        bool CanAllocate = true, bool NeedSize = false);

	template<typename T>
	bool SetTexturePixels(TextureResourceHandle &out, Commands::CommandQueue &q, const T* Pixels, const emath::usvec2 &size,
		Configuration::TextureLoad loadcfg, Device::PixelFormat pxtype, bool AllowAllocate = true, Commands::CommandKey key = Commands::CommandKey()) {
		return SetTexturePixels(out, q, Pixels, size, loadcfg, pxtype, AllowAllocate, key, Device::TypeId<T>, sizeof(T));
	}

	Device::TextureHandle* GetHandleArrayBase() { return &m_GLHandle[0]; }

	emath::usvec2 GetSize(TextureResourceHandle h) const;
    bool IsHandleValid(TextureResourceHandle &h) const;
private: 
	template<typename T>
	using Array = std::array<T, Conf::Limit>;
	using Bitmap = ConfRes::BitmapAllocator<Conf::Limit>;

    Array<TextureResourceHandle::Generation_t> generations;
    Bitmap m_AllocationBitmap;
	Array<Device::TextureHandle> m_GLHandle;
	Array<emath::usvec2> m_TextureSize;

    std::unordered_map<std::string, TextureResourceHandle> loadedTextures; //temporary solution

	ResourceManager *m_ResourceManager = nullptr;
	const Configuration::Texture *m_Settings = nullptr;

	bool SetTexturePixels(TextureResourceHandle &out, Commands::CommandQueue &q, const void* Pixels, const emath::usvec2 &size,
		Configuration::TextureLoad config, Device::PixelFormat pxtype, bool AllowAllocate, Commands::CommandKey key, uint16_t TypeValue, uint16_t ElementSize);
};

//static_assert((sizeof(TextureResource) % 16) == 0, "Invalid size!");
//static_assert(std::is_trivial<TextureResource>::value, "Invalid size!");//atomics

} //namespace MoonGlare::Renderer::Resources 
