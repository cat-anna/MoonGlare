/*
  * Generated by cppsrc.sh
  * On 2016-07-22  0:08:40,44
  * by Paweu
*/
/*--END OF HEADER BLOCK--*/
#include PCH_HEADER
#include "IssueReportDock.h"

#include <ui_IssueReportDock.h>
#include <DockWindowInfo.h>
#include <icons.h>

#include <Module.h>

#include <fmt/format.h>

namespace MoonGlare {
namespace Editor {
namespace DockWindows {

struct IssueReportDockInfo
    : public QtShared::BaseDockWindowModule {

    virtual std::shared_ptr<QtShared::DockWindow> CreateInstance(QWidget *parent) override {
        return std::make_shared<IssueReport>(parent, GetModuleManager());
    }

    IssueReportDockInfo(SharedModuleManager modmgr) : BaseDockWindowModule(std::move(modmgr)) {
        SetSettingID("IssueReport");
        SetDisplayName(tr("Active issues"));
        SetShortcut("F11");
    }
};
QtShared::ModuleClassRgister::Register<IssueReportDockInfo> IssueReportDockInfoReg("IssueReportDock");

//----------------------------------------------------------------------------------

IssueReport::IssueReport(QWidget * parent, QtShared::SharedModuleManager modmgr)
    :  QtShared::DockWindow(parent), moduleManager(std::move(modmgr)) {

    SetSettingID("IssueReport");
    m_Ui = std::make_unique<Ui::IssueReportDock>();
    m_Ui->setupUi(this);

    m_ViewModel = std::make_unique<QStandardItemModel>();
    m_ViewModel->setHorizontalHeaderItem(0, new QStandardItem("Type"));
    m_ViewModel->setHorizontalHeaderItem(1, new QStandardItem("Group"));
    m_ViewModel->setHorizontalHeaderItem(2, new QStandardItem("Message"));
    m_ViewModel->setHorizontalHeaderItem(3, new QStandardItem("File"));
    m_Ui->treeView->setModel(m_ViewModel.get());
    m_Ui->treeView->setSelectionMode(QAbstractItemView::SingleSelection);
    m_Ui->treeView->setEditTriggers(QAbstractItemView::NoEditTriggers);
    m_Ui->treeView->setContextMenuPolicy(Qt::CustomContextMenu);
    m_Ui->treeView->setColumnWidth(0, 70);
    m_Ui->treeView->setColumnWidth(1, 100);
    m_Ui->treeView->setColumnWidth(2, 400);
    m_Ui->treeView->setColumnWidth(3, 200);

    auto issuereporteer = moduleManager->QuerryModule<QtShared::IssueReporter>();
    connect(issuereporteer.get(), &QtShared::IssueReporter::IssueCreated, this, &IssueReport::IssueCreated);
    connect(issuereporteer.get(), &QtShared::IssueReporter::IssueRemoved, this, &IssueReport::IssueRemoved);

    Refresh();
}

IssueReport::~IssueReport() {
    m_Ui.reset();
}

//----------------------------------------------------------------------------------

bool IssueReport::DoSaveSettings(pugi::xml_node node) const {
    SaveColumns(node, "IssueReport:Columns", m_Ui->treeView, 4);
    QtShared::DockWindow::DoSaveSettings(node);
    return true;
}

bool IssueReport::DoLoadSettings(const pugi::xml_node node) {
    LoadColumns(node, "IssueReport:Columns", m_Ui->treeView, 4);
    QtShared::DockWindow::DoLoadSettings(node);
    return true;
}

//----------------------------------------------------------------------------------

void IssueReport::Refresh() {
    errorCount = 0;
    m_ViewModel->removeRows(0, m_ViewModel->rowCount());
    auto issuereporteer = moduleManager->QuerryModule<QtShared::IssueReporter>();
    for (auto &item : issuereporteer->CurrentIssues()) {
        IssueCreated(*item);
    }
}

//----------------------------------------------------------------------------------

void IssueReport::IssueCreated(QtShared::Issue issue) {

    QStandardItem *qitm;
    QList<QStandardItem*> cols;
    cols << (qitm = new QStandardItem());

    switch (issue.type) {
    default:
    case QtShared::Issue::Type::Unknown:
        qitm->setText("?");
        break;
    case QtShared::Issue::Type::Error:
        qitm->setText("Error");
        qitm->setBackground(QBrush(QColor(255, 0, 0, 128)));
        ++errorCount;
//        m_Ui->
      //  titleBarWidget()->s
        break;
    case QtShared::Issue::Type::Warning:
        qitm->setText("Warning");
        qitm->setBackground(QBrush(QColor(255, 255, 0, 128)));
        break;
    case QtShared::Issue::Type::Hint:
        qitm->setText("Hint");
        qitm->setBackground(QBrush(QColor(0, 255, 0, 128)));
        break;
    case QtShared::Issue::Type::Notice:
        qitm->setText("Notice");
        qitm->setBackground(QBrush(QColor(0, 0, 255, 64)));
        break;
    }

    if (errorCount > 0) {
        setWindowTitle(fmt::format("Active issues [{}]", errorCount).c_str());
    }
    else {
        setWindowTitle("Active issues");
    }


    cols << new QStandardItem(issue.group.c_str());
    cols << new QStandardItem(issue.message.c_str());
    if (issue.fileName) {
        cols << new QStandardItem(fmt::format("{}({})", issue.fileName.value_or(""), issue.sourceLine.value_or(0)).c_str());
    }

    qitm->setData(QVariant::fromValue(issue));

    auto root = m_ViewModel->invisibleRootItem();
    root->appendRow(cols);
}

void IssueReport::IssueRemoved(QtShared::Issue) {
    Refresh();
    //TODO: proper implementation!
}

//----------------------------------------------------------------------------------

void IssueReport::ShowContextMenu(const QPoint &point) {
//	QMenu menu;
//	QModelIndex index = m_Ui->treeView->indexAt(point);
//
//	if (index.isValid()) {
//
//	}
//
//	menu.addAction("Open", this, &FileSystemViewer::OpenItem);
//	menu.addSeparator();
//	menu.addAction(ICON_16_REFRESH, "Refresh", this, &FileSystemViewer::RefreshFilesystem);
//
//	menu.exec(m_Ui->treeView->mapToGlobal(point));
}

void IssueReport::ItemDoubleClicked(const QModelIndex&) {
}

} //namespace DockWindows 
} //namespace Editor 
} //namespace MoonGlare 
