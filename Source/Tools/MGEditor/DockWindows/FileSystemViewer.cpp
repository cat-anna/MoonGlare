/*
  * Generated by cppsrc.sh
  * On 2016-07-22  0:08:40,44
  * by Paweu
*/
/*--END OF HEADER BLOCK--*/
#include <pch.h>
#include "FileSystemViewer.h"

#include <ui_FileSystemViewer.h>
#include <DockWindowInfo.h>
#include <icons.h>
#include "../MainWindow.h"
#include "../FileSystem.h"

namespace MoonGlare {
namespace Editor {
namespace DockWindows {

struct FileSystemViewerInfo : public QtShared::DockWindowInfo {
	virtual std::shared_ptr<QtShared::DockWindow> CreateInstance(QWidget *parent) override {
		return std::make_shared<FileSystemViewer>(parent);
	}

	FileSystemViewerInfo(QWidget *Parent): QtShared::DockWindowInfo(Parent) {
		SetSettingID("FileSystemViewerInfo");
		SetDisplayName(tr("Filesystem"));
		SetShortcut("F4");
	}
};
QtShared::DockWindowClassRgister::Register<FileSystemViewerInfo> FileSystemViewerInfoReg("FileSystemViewer");

//-----------------------------------------

FileSystemViewer::FileSystemViewer(QWidget * parent) 
	:  QtShared::DockWindow(parent) {
	SetSettingID("FileSystemViewer");
	m_Ui = std::make_unique<Ui::FilesystemViewer>();
	m_Ui->setupUi(this);

	m_FileSystem = MainWindow::Get()->GetFilesystem();

	m_Ui->treeView->setContextMenuPolicy(Qt::CustomContextMenu);
	connect(m_Ui->treeView, SIGNAL(customContextMenuRequested(const QPoint &)), this, SLOT(ShowContextMenu(const QPoint &)));
	connect(m_Ui->treeView, SIGNAL(doubleClicked(const QModelIndex&)), SLOT(ItemDoubleClicked(const QModelIndex&)));

	connect(Notifications::Get(), SIGNAL(ProjectChanged(Module::SharedDataModule)), this, SLOT(ProjectChanged(Module::SharedDataModule)));
	connect(m_FileSystem.get(), SIGNAL(Changed()), this, SLOT(RefreshFilesystem()));

	m_ViewModel = std::make_unique<QStandardItemModel>();

	m_Ui->treeView->setModel(m_ViewModel.get());
	m_Ui->treeView->setSelectionMode(QAbstractItemView::SingleSelection);
	m_Ui->treeView->setEditTriggers(QAbstractItemView::NoEditTriggers);

	m_Ui->treeView->setColumnWidth(0, 200);
}

FileSystemViewer::~FileSystemViewer() {
	m_Ui.reset();
}

bool FileSystemViewer::DoSaveSettings(pugi::xml_node node) const {
	QtShared::DockWindow::DoSaveSettings(node);
	return true;
}

bool FileSystemViewer::DoLoadSettings(const pugi::xml_node node) {
	QtShared::DockWindow::DoLoadSettings(node);
	return true;
}

void FileSystemViewer::ShowContextMenu(const QPoint &point) {
	QMenu menu;
	QModelIndex index = m_Ui->treeView->indexAt(point);
	auto itemptr = m_ViewModel->itemFromIndex(index);

	menu.addAction("Open", this, &FileSystemViewer::OpenItem);
	menu.addSeparator();

	if (itemptr) {
		menu.addAction("Copy URI", [itemptr]() {
			auto qstr = itemptr->data(FileSystemViewerRole::FileURI).toString();
			QClipboard *clipboard = QApplication::clipboard();
			clipboard->setText(qstr);
		});
		menu.addAction("Copy hash URI", [itemptr]() {
			auto qstr = itemptr->data(FileSystemViewerRole::FileHash).toString();
			QClipboard *clipboard = QApplication::clipboard();
			clipboard->setText(qstr);
		});
		menu.addSeparator();
	}

	menu.addAction(ICON_16_REFRESH, "Refresh", [this]() {
		m_FileSystem->Reload();
		RefreshFilesystem();
	});

	menu.exec(m_Ui->treeView->mapToGlobal(point));
}

void FileSystemViewer::ItemDoubleClicked(const QModelIndex&) {
	OpenItem();
}

void FileSystemViewer::OpenItem() {
	auto selection = m_Ui->treeView->selectionModel()->currentIndex();
	auto parent = selection.parent();

	auto itemptr = m_ViewModel->itemFromIndex(selection);
	if (!itemptr)
		return;

	std::string fullpath = itemptr->data(FileSystemViewerRole::FileFullName).toString().toLocal8Bit().constData();
	MainWindow::Get()->OpenFileEditor(fullpath);
}

void FileSystemViewer::RefreshFilesystem() {
	if (!m_Module) {
	}
	//m_FileSystem->Reload();
	RefreshTreeView();
}

void FileSystemViewer::ProjectChanged(Module::SharedDataModule datamod) {
	m_Module = datamod;
}

void FileSystemViewer::Clear() {
}

void FileSystemViewer::RefreshTreeView() {
	m_ViewModel->clear();
	m_ViewModel->setHorizontalHeaderItem(0, new QStandardItem("File"));

	auto shdata = MainWindow::Get()->GetSharedData();

	decltype(m_VFSItemMap) currmap;
	auto svfs = m_FileSystem->GetVFS();

	StarVFS::HandleEnumerateFunc processitem;
	processitem = [&](StarVFS::FileID fid) -> bool {
		QStandardItem *parent = nullptr;
		QStandardItem *item = nullptr;
		std::swap(m_VFSItemMap[fid], item);

		auto h = svfs->OpenFile(fid);
		if (!h)
			return true;

		if (!item) {
			auto pid = h.GetParrentID();
			parent = currmap[pid];
			if (!parent)
				parent = m_ViewModel->invisibleRootItem();

			QList<QStandardItem*> cols;
			cols << (item = new QStandardItem(h.GetName()));
			parent->appendRow(cols);
		}
		currmap[fid] = item;

		if (h.IsDirectory()) {
			item->setData(ICON_16_FOLDER, Qt::DecorationRole);
			h.EnumerateChildren(processitem);
		} else {
			auto ext = strrchr(h.GetName(), '.');
			if (ext) {
				++ext;
				auto it = shdata->m_FileIconMap.find(ext);
				if (it != shdata->m_FileIconMap.end()) {
					item->setData(QIcon(it->second.c_str()), Qt::DecorationRole);
				} else
					item->setData(QIcon(), Qt::DecorationRole);
			} else
				item->setData(QIcon(), Qt::DecorationRole);
		}

		auto str = h.GetFullPath();
		auto hashuri = StarVFS::MakePathHashURI(h.GetHash());
		auto fileuri = StarVFS::MakeFileURI(str.c_str());
		item->setData(fileuri.c_str(), FileSystemViewerRole::FileURI);
		item->setData(hashuri.c_str(), FileSystemViewerRole::FileHash);
		item->setData(str.c_str(), FileSystemViewerRole::FileFullName);
		h.Close();
		
		return true;
	};

	currmap.swap(m_VFSItemMap);
	for (auto &it : currmap)
		delete it.second;

	auto root = svfs->OpenFile("/");
	//processitem(root.GetFID());
	root.EnumerateChildren(processitem);
	root.Close();

	m_ViewModel->sort(0);
}

} //namespace DockWindows 
} //namespace Editor 
} //namespace MoonGlare 
