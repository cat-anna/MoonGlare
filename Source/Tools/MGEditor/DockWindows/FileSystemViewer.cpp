/*
  * Generated by cppsrc.sh
  * On 2016-07-22  0:08:40,44
  * by Paweu
*/
/*--END OF HEADER BLOCK--*/
#include <pch.h>
#include "FileSystemViewer.h"

#include <ui_FileSystemViewer.h>
#include <DockWindowInfo.h>
#include <icons.h>
#include "../MainWindow.h"
#include "../FileSystem.h"

namespace MoonGlare {
namespace Editor {
namespace DockWindows {

struct FileSystemViewerInfo : public QtShared::DockWindowInfo {
	virtual std::shared_ptr<QtShared::DockWindow> CreateInstance(QWidget *parent) override {
		return std::make_shared<FileSystemViewer>(parent);
	}

	FileSystemViewerInfo(QWidget *Parent): QtShared::DockWindowInfo(Parent) {
		SetSettingID("FileSystemViewerInfo");
		SetDisplayName(tr("Filesystem"));
		SetShortcut("F4");
	}
};
QtShared::DockWindowClassRgister::Register<FileSystemViewerInfo> FileSystemViewerInfoReg("FileSystemViewer");

//-----------------------------------------

FileSystemViewer::FileSystemViewer(QWidget * parent) 
	:  QtShared::DockWindow(parent) {
	SetSettingID("FileSystemViewer");
	m_Ui = std::make_unique<Ui::FilesystemViewer>();
	m_Ui->setupUi(this);

	m_FileSystem = MainWindow::Get()->GetFilesystem();


	m_Ui->treeView->setContextMenuPolicy(Qt::CustomContextMenu);
	connect(m_Ui->treeView, SIGNAL(customContextMenuRequested(const QPoint &)), this, SLOT(ShowContextMenu(const QPoint &)));

	connect(Notifications::Get(), SIGNAL(ProjectChanged(Module::SharedDataModule)), this, SLOT(ProjectChanged(Module::SharedDataModule)));
	connect(m_FileSystem.get(), SIGNAL(Changed()), this, SLOT(RefreshFilesystem()));

	m_ViewModel = std::make_unique<QStandardItemModel>();
	

	m_Ui->treeView->setModel(m_ViewModel.get());
	m_Ui->treeView->setSelectionMode(QAbstractItemView::SingleSelection);

	m_Ui->treeView->setColumnWidth(0, 200);
}

FileSystemViewer::~FileSystemViewer() {
	m_Ui.reset();
}

bool FileSystemViewer::DoSaveSettings(pugi::xml_node node) const {
	QtShared::DockWindow::DoSaveSettings(node);
	return true;
}

bool FileSystemViewer::DoLoadSettings(const pugi::xml_node node) {
	QtShared::DockWindow::DoLoadSettings(node);
	return true;
}

void FileSystemViewer::ShowContextMenu(const QPoint &point) {
	QMenu menu;
	QModelIndex index = m_Ui->treeView->indexAt(point);

	bool ItemAdded = false;
	auto AddSeparator = [&] { 
		if (ItemAdded) {
			menu.addSeparator();
			ItemAdded = false;
		}
	};

	if (index.isValid()) {

	}

	AddSeparator();
	menu.addAction(ICON_16_REFRESH, "Refresh", this, &FileSystemViewer::RefreshFilesystem);

	menu.exec(m_Ui->treeView->mapToGlobal(point));
}

void FileSystemViewer::RefreshFilesystem() {
	Clear();
	if (!m_Module) {

	}
	RefreshTreeView();
}

void FileSystemViewer::ProjectChanged(Module::SharedDataModule datamod) {
	m_Module = datamod;
}

void FileSystemViewer::Clear() {
}

void FileSystemViewer::RefreshTreeView() {
	m_ViewModel->clear();
	m_ViewModel->setHorizontalHeaderItem(0, new QStandardItem("File"));

	decltype(m_VFSItemMap) currmap;
	auto svfs = m_FileSystem->GetVFS();

	StarVFS::HandleEnumerateFunc processitem;
	processitem = [&](StarVFS::FileID fid) -> bool {
		QStandardItem *parent = nullptr;
		QStandardItem *item = nullptr;
		std::swap(m_VFSItemMap[fid], item);

		auto h = svfs->OpenFile(fid);
		if (!item) {
			auto pid = h.GetParrentID();
			parent = currmap[pid];
			if (!parent)
				parent = m_ViewModel->invisibleRootItem();

			QList<QStandardItem*> cols;
			cols << (item = new QStandardItem(h.GetName()));
			parent->appendRow(cols);
		}
		currmap[fid] = item;

		if (h.IsDirectory()) {
			item->setData(ICON_16_FOLDER, Qt::DecorationRole);
			h.EnumerateChildren(processitem);
		} else
			item->setData(QIcon(), Qt::DecorationRole);

		h.Close();

		return true;
	};

	currmap.swap(m_VFSItemMap);
	for (auto &it : currmap)
		delete it.second;

	auto root = svfs->OpenFile("/");
	//processitem(root.GetFID());
	root.EnumerateChildren(processitem);
	root.Close();

	m_ViewModel->sort(0);
}

} //namespace DockWindows 
} //namespace Editor 
} //namespace MoonGlare 
